<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DutchEZ ðŸ§€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .sheet-input { border: 1px solid #e2e8f0; padding: 4px 8px; border-radius: 4px; width: 100%; font-size: 0.875rem; }
        .sheet-input:focus { outline: 2px solid #f59e0b; border-color: transparent; }

        .checkbox-custom { width: 1.1rem; height: 1.1rem; cursor: pointer; accent-color: #f59e0b; }

        #copy-toast { display: none; }
        .menu-item { transition: all 0.2s; }
        .menu-item:hover { transform: translateY(-2px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ðŸ§€ Custom Cheese Hole Pattern ðŸ§€ */
        body {
            /* Base cheese color */
            background-color: #ffd440;

            background-image:
                /* 1. STAGGERED ROW: Front Light Circle (Hole Floor) */
                radial-gradient(circle, #FFF5A0 22%, transparent 23%),
                /* 2. STAGGERED ROW: Back Dark Circle (Deep Shadow) */
                radial-gradient(circle, #f59e0b 25%, transparent 26%),

                /* 3. MAIN ROW: Front Light Circle (Hole Floor) */
                radial-gradient(circle, #FFF5A0 22%, transparent 23%),
                /* 4. MAIN ROW: Back Dark Circle (Deep Shadow) */
                radial-gradient(circle, #f59e0b 25%, transparent 26%);

            /* Increased tile size */
            background-size: 200px 200px;

            background-position:
                /* Staggered Row (Centered in the new 200px tile: 100px center + 3px offset) */
                103px 103px,  /* Light circle */
                100px 100px,  /* Dark circle base */

                /* Main Row (Corner of tile - unchanged) */
                3px 3px,    /* Light circle */
                0px 0px;    /* Dark circle base */

            min-height: 100vh;
        }
    </style>
</head>
<body class="p-4 md:p-8 text-slate-800">
    <div class="max-w-6xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden border border-slate-200">
        <div class="bg-amber-100 p-6 text-slate-900 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold tracking-tight">DutchEZ <span class="text-amber-500">ðŸ§€</span></h1>
                <p class="text-slate-600 text-sm">Make bill splitting a Brie-ze</p>
            </div>
            <div class="flex gap-2">
                <button onclick="copyShareLink()" class="bg-amber-500 hover:bg-amber-600 text-white text-xs font-bold px-4 py-2 rounded transition flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                    </svg>
                    Copy Share Link
                </button>
                <button onclick="resetAll()" class="text-xs bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/50 px-3 py-1 rounded transition">Reset</button>
            </div>
        </div>

        <div class="p-6 space-y-8">
            <section>
                <h2 class="text-sm font-bold text-slate-500 uppercase tracking-widest mb-3">1. Diners</h2>
                <div class="flex flex-wrap gap-2 mb-3" id="people-tags"></div>
                <div class="flex gap-2 items-center flex-wrap">
                    <input type="text" id="person-input" placeholder="Name" class="sheet-input max-w-[200px]" onkeydown="if(event.key==='Enter') addPerson()">
                    <button onclick="addPerson()" class="bg-amber-500 text-white px-4 py-2 rounded-md hover:bg-amber-600 font-medium text-sm transition">Add Person</button>
                    <div id="selected-person-indicator" class="ml-4 text-xs text-slate-500 hidden bg-amber-50 px-3 py-1 rounded-full border border-amber-100">
                        <span class="font-bold text-amber-500">Selected:</span> <span id="selected-person-name" class="text-amber-700 font-bold ml-1"></span>
                        <button onclick="clearSelection()" class="ml-2 text-amber-400 hover:text-red-500 font-bold">&times;</button>
                    </div>
                </div>
            </section>

            <section>
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-sm font-bold text-slate-500 uppercase tracking-widest text-center md:text-left">2. Menu</h2>
                </div>

                <div class="flex items-center border-b border-slate-200 mb-4 overflow-hidden">
                    <div id="restaurant-tabs" class="flex gap-1 overflow-x-auto no-scrollbar pb-1"></div>
                    <button onclick="createNewMenu()" class="ml-2 px-3 py-1 text-sm font-bold text-amber-600 hover:bg-amber-50 rounded bg-transparent border border-amber-200 transition" title="Create New Menu Tab">+</button>
                </div>

                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 mb-4 flex gap-2 items-center flex-wrap">
                    <span class="text-xs font-bold text-slate-400 uppercase mr-2">Add to Menu:</span>
                    <input type="text" id="custom-item-name" placeholder="Item name (e.g. Pizza)" class="sheet-input max-w-[200px]">
                    <input type="number" id="custom-item-price" placeholder="Price" step="0.01" class="sheet-input max-w-[100px] font-mono">
                    <input type="text" id="custom-item-category" placeholder="Category (optional)" class="sheet-input max-w-[150px]" list="category-suggestions">
                    <datalist id="category-suggestions">
                        <option value="Entree"></option>
                        <option value="Appetizer"></option>
                        <option value="Drinks"></option>
                    </datalist>
                    <button onclick="addItemToCurrentMenu()" class="bg-amber-500 text-white px-4 py-2 rounded-md hover:bg-amber-600 font-medium text-sm transition whitespace-nowrap">
                        + Add Item
                    </button>
                </div>

                <div id="menu-container"></div>
            </section>

            <section>
                <h2 class="text-sm font-bold text-slate-500 uppercase tracking-widest mb-4 text-center md:text-left">3. Individual Orders</h2>
                <div id="orders-container" class="space-y-6"></div>
            </section>

            <section>
                <h2 class="text-sm font-bold text-slate-500 uppercase tracking-widest mb-4 text-center md:text-left">4. Shared Items</h2>
                <div class="overflow-x-auto -mx-6 md:mx-0 px-6 md:px-0">
                    <table class="w-full text-left border-collapse min-w-[600px]">
                        <thead>
                            <tr class="border-b border-slate-200 text-[11px] text-slate-400 uppercase font-black">
                                <th class="py-3 px-2">Item</th>
                                <th class="py-3 px-2 w-24">Price ($)</th>
                                <th class="py-3 px-2 w-20">Qty</th>
                                <th class="py-3 px-2">Shared By</th>
                                <th class="py-3 px-2 w-12 text-center"></th>
                            </tr>
                        </thead>
                        <tbody id="shared-items-rows"></tbody>
                    </table>
                </div>
                <button onclick="addSharedItem()" class="mt-4 inline-flex items-center text-amber-600 font-bold text-sm hover:underline">
                    <span class="mr-1 text-lg">+</span> Add Shared Item
                </button>
            </section>

            <section class="pt-6 border-t border-slate-100">
                <h2 class="text-sm font-bold text-slate-500 uppercase tracking-widest mb-4">5. Final Breakdown</h2>
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Tax (%)</label>
                            <input type="number" id="tax-percent" value="9.0" step="0.1" oninput="saveAndCalc(); validateBillTotal();" class="sheet-input font-mono">
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-1">
                                <label class="block text-[10px] font-bold text-slate-400 uppercase">Tip</label>
                                <button id="tip-mode-toggle" onclick="toggleTipMode()" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 px-2 py-0.5 rounded font-bold transition">
                                    %
                                </button>
                            </div>
                            <input type="number" id="tip-percent" value="18.0" step="0.5" oninput="saveAndCalc(); validateBillTotal();" class="sheet-input font-mono">
                            <input type="number" id="tip-dollar" step="0.01" placeholder="0.00" oninput="saveAndCalc(); validateBillTotal();" class="sheet-input font-mono hidden">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Total Bill ($)</label>
                            <input type="number" id="total-bill" step="0.01" placeholder="Enter total from receipt" class="sheet-input font-mono" oninput="validateBillTotal()">
                        </div>
                        <div>
                            <button onclick="calculateBill()" class="w-full bg-orange-500 hover:bg-orange-600 text-white text-sm font-bold px-4 py-2 rounded transition">
                                Calculate Bill
                            </button>
                        </div>
                    </div>
                    <div id="bill-error" class="text-red-600 text-xs font-bold mt-2 hidden"></div>
                </div>
                <div id="results-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
            </section>
        </div>
    </div>

    <div id="copy-toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl text-sm font-bold animate-bounce z-50">
        Link Copied to Clipboard! ðŸš€
    </div>

    <script>
        // Initial Demo Data
        const DEMO_RESTAURANT = {
            "TLT & Grill": [
                { category: "BBQ (çƒ§çƒ¤)", name: "Lamb (ç¾Šè‚‰ä¸²)", price: 3.75 },
                { category: "BBQ (çƒ§çƒ¤)", name: "Beef (ç‰›è‚‰ä¸²)", price: 3.75 },
                { category: "BBQ (çƒ§çƒ¤)", name: "Chicken (é¸¡è‚‰ä¸²)", price: 3.50 },
                { category: "BBQ (çƒ§çƒ¤)", name: "Chicken Wings (çƒ¤é¸¡ç¿…)", price: 4.25 },
                { category: "BBQ (çƒ§çƒ¤)", name: "Squid Tentacles (çƒ¤é±¿é±¼é¡»)", price: 3.99 },
                { category: "BBQ (çƒ§çƒ¤)", name: "Scallop (çƒ¤æ‰‡è´ - 6pcs)", price: 12.99 },
                { category: "BBQ (çƒ§çƒ¤)", name: "Oyster (çƒ¤ç”Ÿèš)", price: 3.99 },
                { category: "BBQ (çƒ§çƒ¤)", name: "Shrimp (çƒ¤è™¾)", price: 1.99 },
                { category: "BBQ (çƒ§çƒ¤)", name: "Sausage (çƒ¤è‚ )", price: 1.99 },
                { category: "BBQ (çƒ§çƒ¤)", name: "Chicken Gizzard (çƒ¤é¸¡èƒ—)", price: 1.99 },
                { category: "BBQ (çƒ§çƒ¤)", name: "Chicken Heart (çƒ¤é¸¡å¿ƒ)", price: 1.99 },
                { category: "BBQ (çƒ§çƒ¤)", name: "Beef Tendon (çƒ¤ç‰›ç­‹)", price: 2.99 },
                { category: "BBQ (çƒ§çƒ¤)", name: "Beef Back Strap (çƒ¤ç‰›æ¿ç­‹)", price: 2.99 },
                { category: "BBQ (çƒ§çƒ¤)", name: "Chicken Skin (çƒ¤é¸¡çš®)", price: 2.99 },
                { category: "BBQ (çƒ§çƒ¤)", name: "Pork Intestine (çƒ¤è‚¥è‚ )", price: 3.99 },
                { category: "BBQ (çƒ§çƒ¤)", name: "Taiwanese Sausage (çƒ¤å°æ¹¾çƒ¤è‚ )", price: 3.99 },
                { category: "BBQ (çƒ§çƒ¤)", name: "Grilled Eggplant (çƒ¤å…¨èŒ„)", price: 8.99 },
                { category: "BBQ (çƒ§çƒ¤)", name: "Corn (çƒ¤çŽ‰ç±³)", price: 2.50 },
                { category: "BBQ (çƒ§çƒ¤)", name: "Chinese Chives (çƒ¤éŸ­èœ)", price: 2.50 },
                { category: "BBQ (çƒ§çƒ¤)", name: "String Beans (çƒ¤è±†è§’)", price: 2.50 },
                { category: "BBQ (çƒ§çƒ¤)", name: "Potato (çƒ¤åœŸè±†ç‰‡)", price: 1.99 },
                { category: "Rice and Soup (åœ°æ–¹å°åƒ)", name: "Egg Fried Rice (è›‹ç‚’é¥­)", price: 13.99 },
                { category: "Rice and Soup (åœ°æ–¹å°åƒ)", name: "Yangzhou Fried Rice (æ‰¬å·žç‚’é¥­)", price: 14.99 },
                { category: "Rice and Soup (åœ°æ–¹å°åƒ)", name: "Wonton Soup (é¦„é¥¨)", price: 13.99 },
                { category: "Rice and Soup (åœ°æ–¹å°åƒ)", name: "Doughboy Soup (ç–™ç˜©æ±¤)", price: 13.99 },
                { category: "Rice and Soup (åœ°æ–¹å°åƒ)", name: "Cold Noodle (å†·é¢)", price: 13.99 },
                { category: "Rice and Soup (åœ°æ–¹å°åƒ)", name: "Spicy Vegetables (éº»è¾£çƒ«)", price: 14.99 },
                { category: "Salad (å‡‰æ‹Œèœ)", name: "Pork & Cucumber Salad (è‚˜èŠ±æ‹é»„ç“œ)", price: 8.99 },
                { category: "Salad (å‡‰æ‹Œèœ)", name: "Seaweed with Garlic Sauce (è’œæ±æµ·å¸¦ä¸)", price: 8.99 },
                { category: "Salad (å‡‰æ‹Œèœ)", name: "Spicy Potato Salad (å‘›æ‹ŒåœŸè±†ä¸)", price: 8.99 },
                { category: "Salad (å‡‰æ‹Œèœ)", name: "Home Style Salad (å®¶å¸¸å‡‰èœ)", price: 8.99 },
                { category: "Entree (ç‰¹è‰²å°ç‚’)", name: "Sweet and Sour Pork Tenderloin (é”…åŒ…è‚‰)", price: 20.99 },
                { category: "Entree (ç‰¹è‰²å°ç‚’)", name: "Bell Pepper with Dry Tofu (å°–æ¤’å¹²è±†è…)", price: 16.99 },
                { category: "Entree (ç‰¹è‰²å°ç‚’)", name: "Chill Cabbage (ç«çˆ†å¤´èœ)", price: 15.99 },
                { category: "Entree (ç‰¹è‰²å°ç‚’)", name: "Fried Sweet Potato (æ‹”ä¸åœ°ç“œ)", price: 16.99 }
            ]
        };

        let state = {
            people: ["Me", "Friend 1"],
            restaurants: JSON.parse(JSON.stringify(DEMO_RESTAURANT)),
            selectedRestaurant: "TLT & Grill",
            orders: {},
            sharedItems: [],
            tax: 9.0,
            tip: 18.0,
            tipMode: 'percent',
            selectedPerson: null
        };

        function init() {
            // Load state logic
            state.people.forEach(p => { if (!state.orders[p]) state.orders[p] = []; });
            if (!state.sharedItems) state.sharedItems = [];

            // Initial default selection
            if (!state.selectedPerson && state.people.length > 0) state.selectedPerson = state.people[0];

            // Priority 1: URL Parameters
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('bill');

            if (dataParam) {
                try {
                    const urlDecoded = decodeURIComponent(dataParam);
                    const decodedData = JSON.parse(decodeBase64Unicode(urlDecoded));
                    state = { ...state, ...decodedData };
                    if (!state.restaurants || Object.keys(state.restaurants).length === 0) {
                        state.restaurants = JSON.parse(JSON.stringify(DEMO_RESTAURANT));
                    }
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (e) {
                    console.error("Invalid share link", e);
                    alert("Invalid share link.");
                }
            } else {
                // Priority 2: LocalStorage
                const saved = localStorage.getItem('bill_splitter_state');
                if (saved) {
                    try {
                        const loaded = JSON.parse(saved);
                        state = { ...state, ...loaded };
                        if(state.customMenuItems) delete state.customMenuItems;
                    } catch(e) { console.error(e); }
                }
            }

            const restKeys = Object.keys(state.restaurants);
            if (restKeys.length > 0 && !state.restaurants[state.selectedRestaurant]) {
                state.selectedRestaurant = restKeys[0];
            } else if (restKeys.length === 0) {
                state.restaurants["My Menu"] = [];
                state.selectedRestaurant = "My Menu";
            }

            document.getElementById('tax-percent').value = state.tax;
            if (!state.tipMode) state.tipMode = 'percent';

            const tipPercentInput = document.getElementById('tip-percent');
            const tipDollarInput = document.getElementById('tip-dollar');
            const toggleButton = document.getElementById('tip-mode-toggle');

            if (state.tipMode === 'percent') {
                tipPercentInput.value = state.tip;
                tipPercentInput.classList.remove('hidden');
                tipDollarInput.classList.add('hidden');
                toggleButton.textContent = '%';
            } else {
                const totalSubtotal = getTotalSubtotal();
                const tipDollar = totalSubtotal > 0 ? (totalSubtotal * state.tip / 100) : 0;
                tipDollarInput.value = tipDollar.toFixed(2);
                tipPercentInput.classList.add('hidden');
                tipDollarInput.classList.remove('hidden');
                toggleButton.textContent = '$';
            }

            renderAll();
        }

        // --- Core Functions ---

        function createNewMenu() {
            const name = prompt("Enter name for new menu (e.g., 'Pizza Place'):");
            if (name && name.trim()) {
                const cleanName = name.trim();
                if (state.restaurants[cleanName]) {
                    alert("Menu name already exists.");
                    return;
                }
                state.restaurants[cleanName] = [];
                state.selectedRestaurant = cleanName;
                renderAll();
            }
        }

        function deleteMenu(name) {
            if (Object.keys(state.restaurants).length <= 1) {
                alert("You must have at least one menu.");
                return;
            }
            if (confirm(`Delete menu "${name}" and all its items?`)) {
                delete state.restaurants[name];
                state.selectedRestaurant = Object.keys(state.restaurants)[0];
                renderAll();
            }
        }

        function addItemToCurrentMenu() {
            const nameInput = document.getElementById('custom-item-name');
            const priceInput = document.getElementById('custom-item-price');
            const catInput = document.getElementById('custom-item-category');

            const name = nameInput.value.trim();
            const price = parseFloat(priceInput.value);
            const category = catInput.value.trim() || "Custom Items";

            if (name && price > 0) {
                state.restaurants[state.selectedRestaurant].push({ name, price, category });
                nameInput.value = '';
                priceInput.value = '';
                catInput.value = '';
                renderMenu();
                saveAndCalc();
            } else {
                alert("Please enter a valid name and price.");
            }
        }

        function deleteItemFromMenu(index) {
            const menuList = state.restaurants[state.selectedRestaurant];
            if (!menuList || !menuList[index]) return;

            const item = menuList[index];
            const itemName = item.name;

            // Check if used in orders
            let isUsed = false;

            // Check individual orders
            Object.values(state.orders).forEach(userOrders => {
                if (userOrders.some(order => order.itemName === itemName)) {
                    isUsed = true;
                }
            });

            // Check shared items
            if (!isUsed) {
                if (state.sharedItems.some(shared => shared.name === itemName)) {
                    isUsed = true;
                }
            }

            let confirmMessage = `Delete "${itemName}" from the menu?`;
            if (isUsed) {
                confirmMessage = `âš ï¸ "${itemName}" is currently in someone's order.\n\nDeleting it will remove it from ALL orders and update the totals.\n\nAre you sure?`;
            }

            if (confirm(confirmMessage)) {
                // 1. Remove from menu
                state.restaurants[state.selectedRestaurant].splice(index, 1);

                // 2. Remove from individual orders
                Object.keys(state.orders).forEach(person => {
                    state.orders[person] = state.orders[person].filter(order => order.itemName !== itemName);
                });

                // 3. Remove from shared items
                state.sharedItems = state.sharedItems.filter(shared => shared.name !== itemName);

                renderMenu();
                renderAll(); // Renders orders section too
                saveAndCalc();
            }
        }

        // --- Render Functions ---

        function renderRestaurantTabs() {
            const tabsContainer = document.getElementById('restaurant-tabs');
            const restaurants = Object.keys(state.restaurants);

            tabsContainer.innerHTML = restaurants.map(restaurant => {
                const isActive = state.selectedRestaurant === restaurant;
                const showDelete = isActive && restaurants.length > 1;
                const paddingClass = showDelete ? 'pl-4 pr-8' : 'px-4';

                return `
                <div class="group relative flex items-center">
                    <button onclick="selectRestaurant('${restaurant.replace(/'/g, "\\'")}')"
                            class="${paddingClass} py-2 text-sm font-bold transition whitespace-nowrap rounded-t-lg border-b-2 ${
                                isActive
                                    ? 'bg-amber-500 text-white border-amber-600'
                                    : 'bg-slate-100 text-slate-600 border-transparent hover:bg-slate-200'
                            }">
                        ${restaurant}
                    </button>
                    ${showDelete ? `
                        <button onclick="deleteMenu('${restaurant.replace(/'/g, "\\'")}')"
                                class="absolute right-1 top-1/2 -translate-y-1/2 text-xs text-amber-200 hover:text-white font-bold w-5 h-5 flex items-center justify-center rounded hover:bg-red-500/50 leading-none"
                                title="Delete Menu">&times;</button>
                    ` : ''}
                </div>
            `;
            }).join('');
        }

        function renderMenu() {
            const container = document.getElementById('menu-container');
            const menuItems = state.restaurants[state.selectedRestaurant] || [];

            if (menuItems.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-8 border-2 border-dashed border-slate-200 rounded-xl text-slate-400">
                        <p class="mb-2">This menu is empty.</p>
                        <p class="text-xs">Use the "Add to Menu" form above to build it!</p>
                    </div>`;
                return;
            }

            const itemsByCategory = {};
            menuItems.forEach((item, index) => {
                const category = item.category || 'Other';
                if (!itemsByCategory[category]) itemsByCategory[category] = [];
                itemsByCategory[category].push({ ...item, originalIndex: index });
            });

            container.innerHTML = Object.keys(itemsByCategory).map(category => {
                const items = itemsByCategory[category];
                return `
                    <div class="mb-6">
                        <h3 class="text-sm font-bold text-slate-600 uppercase mb-3 pb-2 border-b border-slate-200">${category}</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                            ${items.map(item => `
                                <div class="menu-item bg-white border border-slate-200 rounded-lg p-3 hover:border-amber-300 hover:shadow-md relative group">
                                    <button onclick="deleteItemFromMenu(${item.originalIndex})" class="absolute top-1 right-1 text-slate-200 hover:text-red-400 hidden group-hover:block px-2">Ã—</button>
                                    <div class="flex justify-between items-start mb-1 cursor-pointer"
                                         onclick="addOrderToSelectedPerson('${item.name.replace(/'/g, "\\'")}', ${item.price})">
                                        <span class="font-bold text-sm text-slate-900 pr-4">${item.name}</span>
                                        <span class="font-mono text-sm text-amber-600">$${item.price.toFixed(2)}</span>
                                    </div>
                                    <div class="flex gap-1 mt-2">
                                        <button onclick="event.stopPropagation(); addOrderToSelectedPerson('${item.name.replace(/'/g, "\\'")}', ${item.price})"
                                                class="flex-1 bg-amber-500 hover:bg-amber-600 text-white text-xs px-2 py-1 rounded text-[10px] font-bold transition">
                                            Add to Person
                                        </button>
                                        <button onclick="event.stopPropagation(); addSharedItemFromMenu('${item.name.replace(/'/g, "\\'")}', ${item.price})"
                                                class="flex-1 bg-orange-500 hover:bg-orange-600 text-white text-xs px-2 py-1 rounded text-[10px] font-bold transition">
                                            Share Item
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- Standard Logic ---

        function encodeBase64Unicode(str) {
            const utf8Bytes = new TextEncoder().encode(str);
            let binary = '';
            for (let i = 0; i < utf8Bytes.length; i++) binary += String.fromCharCode(utf8Bytes[i]);
            return btoa(binary);
        }

        function decodeBase64Unicode(str) {
            const binary = atob(str);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            return new TextDecoder().decode(bytes);
        }

        function copyShareLink() {
            try {
                const encoded = encodeBase64Unicode(JSON.stringify(state));
                const urlEncoded = encodeURIComponent(encoded);
                const shareUrl = window.location.origin + window.location.pathname + "?bill=" + urlEncoded;

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(shareUrl).then(() => showToast("Link Copied to Clipboard! ðŸš€"));
                } else {
                    fallbackCopyToClipboard(shareUrl);
                }
            } catch (e) { alert("Failed to copy link"); }
        }

        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.focus(); textArea.select();
            try {
                document.execCommand('copy');
                showToast("Link Copied to Clipboard! ðŸš€");
            } catch (err) { prompt("Copy this link:", text); }
            document.body.removeChild(textArea);
        }

        function showToast(message) {
            const toast = document.getElementById('copy-toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 3000);
        }

        function saveAndCalc() {
            state.tax = parseFloat(document.getElementById('tax-percent').value) || 0;
            if (state.tipMode === 'percent') {
                state.tip = parseFloat(document.getElementById('tip-percent').value) || 0;
            } else {
                const tipDollar = parseFloat(document.getElementById('tip-dollar').value) || 0;
                const totalSubtotal = getTotalSubtotal();
                state.tip = totalSubtotal > 0 ? (tipDollar / totalSubtotal * 100) : 0;
            }
            localStorage.setItem('bill_splitter_state', JSON.stringify(state));
            calculate();
            validateBillTotal();
        }

        function toggleTipMode() {
            const tipPercentInput = document.getElementById('tip-percent');
            const tipDollarInput = document.getElementById('tip-dollar');
            const toggleButton = document.getElementById('tip-mode-toggle');
            const totalSubtotal = getTotalSubtotal();

            if (state.tipMode === 'percent') {
                state.tipMode = 'dollar';
                const tipPercent = parseFloat(tipPercentInput.value) || 0;
                const tipDollar = totalSubtotal > 0 ? (totalSubtotal * tipPercent / 100) : 0;
                tipDollarInput.value = tipDollar.toFixed(2);
                tipPercentInput.classList.add('hidden');
                tipDollarInput.classList.remove('hidden');
                toggleButton.textContent = '$';
            } else {
                state.tipMode = 'percent';
                const tipDollar = parseFloat(tipDollarInput.value) || 0;
                const tipPercent = totalSubtotal > 0 ? (tipDollar / totalSubtotal * 100) : 0;
                tipPercentInput.value = tipPercent.toFixed(2);
                tipDollarInput.classList.add('hidden');
                tipPercentInput.classList.remove('hidden');
                toggleButton.textContent = '%';
            }
            saveAndCalc();
        }

        function getTotalSubtotal() {
            let totalSubtotal = 0;
            state.people.forEach(p => {
                (state.orders[p] || []).forEach(o => totalSubtotal += (o.price || 0) * (o.quantity || 0));
            });
            (state.sharedItems || []).forEach(item => {
                if (item.sharedBy && item.sharedBy.length > 0) totalSubtotal += (item.price || 0) * (item.quantity || 0);
            });
            return totalSubtotal;
        }

        function validateBillTotal() {
            const totalBillInput = document.getElementById('total-bill');
            const errorDiv = document.getElementById('bill-error');
            const enteredTotalBill = parseFloat(totalBillInput.value) || 0;
            const subtotal = getTotalSubtotal();

            if (subtotal === 0 || enteredTotalBill === 0) {
                errorDiv.classList.add('hidden');
                return;
            }

            const taxRate = state.tax / 100;
            const tipRate = state.tipMode === 'percent'
                ? state.tip / 100
                : (parseFloat(document.getElementById('tip-dollar').value) || 0) / subtotal;

            const expectedTotalBill = subtotal * (1 + taxRate + tipRate);

            if (Math.abs(enteredTotalBill - expectedTotalBill) > 0.05) {
                errorDiv.textContent = `âš ï¸ Mismatch! Expected: $${expectedTotalBill.toFixed(2)}, Entered: $${enteredTotalBill.toFixed(2)}`;
                errorDiv.classList.remove('hidden');
            } else {
                errorDiv.classList.add('hidden');
            }
        }

        function calculateBill() {
            const totalBillInput = document.getElementById('total-bill');
            const errorDiv = document.getElementById('bill-error');
            const taxPercentInput = document.getElementById('tax-percent');
            const tipPercentInput = document.getElementById('tip-percent');
            const tipDollarInput = document.getElementById('tip-dollar');

            const taxPercent = parseFloat(taxPercentInput.value) || 0;
            const enteredTotalBill = parseFloat(totalBillInput.value) || 0;
            const subtotal = getTotalSubtotal();

            if (subtotal === 0) {
                errorDiv.textContent = "Please add items first.";
                errorDiv.classList.remove('hidden');
                return;
            }

            let tipPercent = 0;
            if (state.tipMode === 'percent') {
                tipPercent = parseFloat(tipPercentInput.value) || 0;
            } else {
                const tipDollar = parseFloat(tipDollarInput.value) || 0;
                tipPercent = subtotal > 0 ? (tipDollar / subtotal * 100) : 0;
            }

            // Case 1: Reverse Calc Tax (Tip & Total Bill exists, Tax is 0)
            if (tipPercent > 0 && enteredTotalBill > 0 && taxPercent === 0) {
                const tipRate = tipPercent / 100;
                const calculatedTaxPercent = ((enteredTotalBill / subtotal) - 1 - tipRate) * 100;

                if (calculatedTaxPercent >= 0 && calculatedTaxPercent <= 100) {
                    taxPercentInput.value = calculatedTaxPercent.toFixed(2);
                    state.tax = calculatedTaxPercent;
                    errorDiv.classList.add('hidden');
                    saveAndCalc();
                } else {
                    errorDiv.textContent = `âš ï¸ Cannot calculate tax. Check inputs.`;
                    errorDiv.classList.remove('hidden');
                }
            }
            // Case 2: Reverse Calc Tip (Tax & Total Bill exists, Tip is 0)
            else if (taxPercent > 0 && enteredTotalBill > 0 && tipPercent === 0) {
                const taxRate = taxPercent / 100;
                const calculatedTipPercent = ((enteredTotalBill / subtotal) - 1 - taxRate) * 100;

                if (calculatedTipPercent >= 0 && calculatedTipPercent <= 100) {
                    if (state.tipMode === 'percent') {
                        tipPercentInput.value = calculatedTipPercent.toFixed(2);
                    } else {
                        tipDollarInput.value = (subtotal * calculatedTipPercent / 100).toFixed(2);
                    }
                    state.tip = calculatedTipPercent;
                    errorDiv.classList.add('hidden');
                    saveAndCalc();
                } else {
                    errorDiv.textContent = `âš ï¸ Cannot calculate tip. Check inputs.`;
                    errorDiv.classList.remove('hidden');
                }
            }
            // Case 3: Forward Calc Total Bill (Tax & Tip exists)
            else if (taxPercent > 0 && tipPercent > 0) {
                const taxRate = taxPercent / 100;
                const tipRate = tipPercent / 100;
                const expectedTotal = subtotal * (1 + taxRate + tipRate);

                totalBillInput.value = expectedTotal.toFixed(2);
                errorDiv.classList.add('hidden');
                validateBillTotal();
                saveAndCalc();
            } else {
                errorDiv.textContent = "Please enter tax and tip (or total bill) to calculate";
                errorDiv.classList.remove('hidden');
            }
        }

        function addPerson() {
            const input = document.getElementById('person-input');
            let name = input.value.trim();
            if (!name) {
                let friendNum = 1;
                while (state.people.includes(`Friend ${friendNum}`)) friendNum++;
                name = `Friend ${friendNum}`;
            }
            if (!state.people.includes(name)) {
                state.people.push(name);
                state.orders[name] = [];
                if (!state.selectedPerson) state.selectedPerson = name;
                input.value = '';
                renderAll();
            }
        }

        function selectPerson(name) { state.selectedPerson = name; renderAll(); }
        function clearSelection() { state.selectedPerson = null; renderAll(); }

        function removePerson(name) {
            state.people = state.people.filter(p => p !== name);
            delete state.orders[name];
            state.sharedItems.forEach(item => {
                if (item.sharedBy) item.sharedBy = item.sharedBy.filter(p => p !== name);
            });
            if (state.selectedPerson === name) state.selectedPerson = state.people[0] || null;
            renderAll();
        }

        function selectRestaurant(name) {
            state.selectedRestaurant = name;
            renderAll();
        }

        function addOrder(personName, itemName, price) {
            if (!state.orders[personName]) state.orders[personName] = [];
            state.orders[personName].push({ itemName, quantity: 1, price });
            renderAll();
        }

        function addOrderToSelectedPerson(itemName, price) {
            if (state.people.length === 0) { alert("Add a person first!"); return; }
            addOrder(state.selectedPerson || state.people[0], itemName, price);
        }

        function removeOrder(personName, index) {
            state.orders[personName].splice(index, 1);
            renderAll();
        }

        function updateOrderQuantity(personName, index, quantity) {
            const qty = parseInt(quantity) || 0;
            if (qty > 0) state.orders[personName][index].quantity = qty;
            else state.orders[personName].splice(index, 1);
            renderAll();
        }

        function addSharedItem() {
            if (state.people.length === 0) { alert("Add a person first!"); return; }
            state.sharedItems.push({ name: "", price: 0, quantity: 1, sharedBy: [...state.people] });
            renderAll();
        }

        function addSharedItemFromMenu(itemName, price) {
            if (state.people.length === 0) { alert("Add a person first!"); return; }
            state.sharedItems.push({ name: itemName, price: price, quantity: 1, sharedBy: [...state.people] });
            renderAll();
        }

        function removeSharedItem(index) {
            state.sharedItems.splice(index, 1);
            renderAll();
        }

        function updateSharedItem(idx, field, val) {
            if (field === 'name') state.sharedItems[idx].name = val;
            else state.sharedItems[idx][field] = parseFloat(val) || 0;
            saveAndCalc();
        }

        function toggleSharedBy(itemIdx, name) {
            const list = state.sharedItems[itemIdx].sharedBy;
            const idx = list.indexOf(name);
            if (idx > -1) list.splice(idx, 1);
            else list.push(name);
            saveAndCalc();
        }

        function selectAllShared(index) {
            state.sharedItems[index].sharedBy = [...state.people];
            saveAndCalc();
            renderAll();
        }

        function clearAllShared(index) {
            state.sharedItems[index].sharedBy = [];
            saveAndCalc();
            renderAll();
        }

        function resetAll() {
            if(confirm("Clear everything and reset?")) {
                localStorage.removeItem('bill_splitter_state');
                location.reload(); // Simple reload to clear memory state
            }
        }

        function renderAll() {
            // Render People
            const tags = document.getElementById('people-tags');
            tags.innerHTML = state.people.map(p => `
                <span class="bg-slate-100 text-slate-700 pl-3 pr-1 py-1 rounded-md text-xs font-bold border ${state.selectedPerson === p ? 'border-amber-500 bg-amber-50 ring-1 ring-amber-500' : 'border-slate-200'} flex items-center cursor-pointer select-none"
                      onclick="selectPerson('${p.replace(/'/g, "\\'")}')">
                    ${p}
                    ${state.selectedPerson === p ? '<span class="ml-2 text-indigo-600">âœ“</span>' : ''}
                    <button onclick="event.stopPropagation(); removePerson('${p.replace(/'/g, "\\'")}')" class="ml-2 w-5 h-5 rounded hover:bg-red-100 hover:text-red-500 transition">&times;</button>
                </span>
            `).join('');

            const indicator = document.getElementById('selected-person-indicator');
            const nameSpan = document.getElementById('selected-person-name');
            if (state.selectedPerson && state.people.includes(state.selectedPerson)) {
                indicator.classList.remove('hidden');
                nameSpan.textContent = state.selectedPerson;
            } else {
                indicator.classList.add('hidden');
            }

            renderRestaurantTabs();
            renderMenu();

            // Render Orders
            const container = document.getElementById('orders-container');
            container.innerHTML = state.people.map(personName => {
                const orders = state.orders[personName] || [];
                return `
                    <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
                        <div class="flex justify-between items-center mb-3 pb-2 border-b border-slate-200">
                            <h3 class="font-bold text-slate-900">${personName}'s Orders</h3>
                            <button onclick="selectPerson('${personName.replace(/'/g, "\\'")}')" class="text-xs text-amber-600 font-bold hover:underline">Select</button>
                        </div>
                        ${orders.length === 0 ?
                            '<p class="text-xs text-slate-400 italic">No items ordered yet.</p>' :
                            `<div class="space-y-2">
                                ${orders.map((order, idx) => `
                                    <div class="bg-white border border-slate-200 rounded-lg p-2 flex items-center justify-between group">
                                        <div class="flex-1 min-w-0 pr-2">
                                            <div class="font-medium text-sm text-slate-900 truncate" title="${order.itemName}">${order.itemName}</div>
                                            <div class="text-[10px] text-slate-500">$${order.price.toFixed(2)}</div>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <input type="number" value="${order.quantity}" min="1"
                                                   onchange="updateOrderQuantity('${personName.replace(/'/g, "\\'")}', ${idx}, this.value)"
                                                   class="sheet-input w-12 font-mono text-center text-xs h-7">
                                            <span class="text-xs font-mono text-slate-700 w-14 text-right">$${(order.price * order.quantity).toFixed(2)}</span>
                                            <button onclick="removeOrder('${personName.replace(/'/g, "\\'")}', ${idx})"
                                                    class="text-slate-300 hover:text-red-500 text-lg px-1">&times;</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>
                `;
            }).join('');

            // Render Shared
            const sharedRows = document.getElementById('shared-items-rows');
            if (state.sharedItems.length > 0) {
                sharedRows.innerHTML = state.sharedItems.map((item, i) => `
                    <tr class="group border-b border-slate-50 hover:bg-slate-50/50 transition">
                        <td class="py-2 px-2"><input type="text" value="${item.name}" oninput="updateSharedItem(${i}, 'name', this.value)" class="sheet-input text-xs" placeholder="Item Name"></td>
                        <td class="py-2 px-2"><input type="number" value="${item.price}" step="0.01" oninput="updateSharedItem(${i}, 'price', this.value)" class="sheet-input font-mono text-xs"></td>
                        <td class="py-2 px-2"><input type="number" value="${item.quantity}" min="1" oninput="updateSharedItem(${i}, 'quantity', this.value)" class="sheet-input font-mono text-xs"></td>
                        <td class="py-2 px-2">
                            <div class="flex gap-2 mb-2">
                                <button onclick="selectAllShared(${i})" class="text-[10px] bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-0.5 rounded transition">All</button>
                                <button onclick="clearAllShared(${i})" class="text-[10px] bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-0.5 rounded transition">None</button>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                ${state.people.map(p => `
                                    <label class="flex items-center space-x-1 cursor-pointer group/check select-none">
                                        <input type="checkbox" ${(item.sharedBy || []).includes(p) ? 'checked' : ''} onchange="toggleSharedBy(${i}, '${p.replace(/'/g, "\\'")}')" class="checkbox-custom w-4 h-4">
                                        <span class="text-[10px] font-medium text-slate-500 group-hover/check:text-amber-600">${p}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </td>
                        <td class="py-2 px-2 text-center"><button onclick="removeSharedItem(${i})" class="text-slate-300 hover:text-red-500 text-lg">&times;</button></td>
                    </tr>
                `).join('');
            } else {
                sharedRows.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-xs text-slate-400 italic">No shared items.</td></tr>';
            }

            saveAndCalc();
        }

        function calculate() {
            const taxRate = state.tax / 100;
            const totalSubtotal = getTotalSubtotal();

            let tipRate = state.tipMode === 'percent'
                ? state.tip / 100
                : (totalSubtotal > 0 ? (parseFloat(document.getElementById('tip-dollar').value) || 0) / totalSubtotal : 0);

            let totals = {};
            state.people.forEach(p => totals[p] = { sub: 0 });

            // Sum Individual
            state.people.forEach(p => {
                (state.orders[p] || []).forEach(o => totals[p].sub += (o.price || 0) * (o.quantity || 0));
            });

            // Sum Shared
            (state.sharedItems || []).forEach(item => {
                if (item.sharedBy && item.sharedBy.length > 0) {
                    const costPerPerson = ((item.price || 0) * (item.quantity || 0)) / item.sharedBy.length;
                    item.sharedBy.forEach(p => { if (totals[p]) totals[p].sub += costPerPerson; });
                }
            });

            const grid = document.getElementById('results-grid');
            grid.innerHTML = '';

            let grandTotal = 0;
            state.people.forEach(p => {
                const t = totals[p];
                t.tax = t.sub * taxRate;
                t.tip = t.sub * tipRate;
                t.total = t.sub + t.tax + t.tip;
                grandTotal += t.total;
            });

            // Summary Card
            grid.innerHTML += `
                <div class="bg-gradient-to-br from-amber-50 to-orange-50 border-2 border-amber-200 p-5 rounded-xl shadow-md col-span-full">
                    <h3 class="font-black text-slate-900 mb-3 border-b border-amber-200 pb-2">Summary</h3>
                    <div class="flex justify-between text-xs text-slate-600 mb-1"><span>Subtotal</span><span class="font-mono">$${totalSubtotal.toFixed(2)}</span></div>
                    <div class="flex justify-between text-xs text-slate-600 mb-1"><span>Tax (${state.tax}%)</span><span class="font-mono">$${(totalSubtotal * taxRate).toFixed(2)}</span></div>
                    <div class="flex justify-between text-xs text-slate-600 mb-4"><span>Tip (${(tipRate * 100).toFixed(2)}%)</span><span class="font-mono">$${(totalSubtotal * tipRate).toFixed(2)}</span></div>
                    <div class="flex justify-between items-end pt-2 border-t border-amber-200">
                        <span class="text-xs font-black uppercase text-amber-600">Grand Total</span>
                        <span class="text-2xl font-mono font-bold text-amber-900">$${grandTotal.toFixed(2)}</span>
                    </div>
                </div>
            `;

            // Individual Cards
            state.people.forEach(p => {
                const t = totals[p];
                grid.innerHTML += `
                    <div class="bg-white border border-slate-200 p-5 rounded-xl shadow-sm hover:shadow-md transition">
                        <h3 class="font-black text-slate-900 mb-3 border-b border-slate-100 pb-2 truncate">${p}</h3>
                        <div class="space-y-1.5 mb-4">
                            <div class="flex justify-between text-xs text-slate-500"><span>Food</span><span>$${t.sub.toFixed(2)}</span></div>
                            <div class="flex justify-between text-xs text-slate-500"><span>Tax</span><span>$${t.tax.toFixed(2)}</span></div>
                            <div class="flex justify-between text-xs text-slate-500"><span>Tip</span><span>$${t.tip.toFixed(2)}</span></div>
                        </div>
                        <div class="flex justify-between items-end">
                            <span class="text-[10px] font-black uppercase text-amber-500">Total</span>
                            <span class="text-xl font-mono font-bold text-slate-900">$${t.total.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            });
        }

        init();
    </script>
</body>
</html>
